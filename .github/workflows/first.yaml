name: CI-CD Security Pipeline

on:
  pull_request:
    branches: [ "main", "test" ]
  push:
    branches: [ "main", "test" ]

permissions:
  contents: write          # create-pull-request ve checkout için
  pull-requests: write
  security-events: write   # SARIF upload için şart
  actions: read            # CodeQL / upload-sarif "Resource not accessible" fix

jobs:
  # 1) SECURITY GATE - Tüm PR'lar için (main ve test)
  security_gate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # CodeQL - SAST
      - name: Init CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3

      # Semgrep - Ek SAST
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep --config auto continue-on-error --sarif --output semgrep.sarif

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

      # Code Quality - Super Linter
      - name: Run Super Linter
        uses: github/super-linter/slim@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: true
          DEFAULT_BRANCH: main

      # Dockerfile Quality - Hadolint
      - name: Install Hadolint
        run: |
          wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

      - name: Run Hadolint
        run: |
          if [ -f Dockerfile ]; then hadolint Dockerfile; fi

      # Container / Dependency Scan - Trivy
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb stable main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: Trivy FS Scan (vuln+config)
        run: |
          trivy fs . \
            --security-checks vuln,config \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --format sarif \
            --output trivy.sarif

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy.sarif

      # Secret Scan - Gitleaks
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --report-format sarif --report-path gitleaks.sarif

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

  # 2) MAIN -> TEST OTOMATİK PROMOTION (main'e push sonrası)
  promote_to_test:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create PR from main to test
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Promote main to test"
          body: "Auto-generated promotion PR from main to test after successful merge."
          base: test
          branch: auto/promote-main-to-test
          # head default olarak branch parametresini kullanacak (auto/promote-main-to-test)
          labels: |
            auto-promote
            staging

  # 3) TEST -> DEPLOY (test'e push olunca otomatik deploy)
  deploy_from_test:
    if: github.event_name == 'push' && github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run deploy script
        run: |
          echo "Deploying from test to production..."
          # ./deploy.sh
